set -euo pipefail

scriptDir="$(cd -- "$(dirname "$0")" && pwd)"
installDir="${HOME}/.config/zsh/plugins/to-zsh"
targetScript="${installDir}/to.zsh"
zshrc="${HOME}/.zshrc"
startMarker="# >>> to-zsh init >>>"
endMarker="# <<< to-zsh init <<<"

mkdir -p "$installDir"

copyAction="installed"

if [ -f "$targetScript" ]; then
  if cmp -s "${scriptDir}/to.zsh" "$targetScript"; then
    copyAction="unchanged"
  else
    copyAction="updated"
  fi
fi

cp "${scriptDir}/to.zsh" "$targetScript"

if [ ! -f "$zshrc" ]; then

  touch "$zshrc"
fi

printf 'Installing to-zsh from %s\n' "$scriptDir"
printf 'Copying function script to %s\n' "$targetScript"

snippet=$(cat <<'EOF'
# >>> to-zsh init >>>
autoload -Uz compinit
compinit

TO_FUNC_PATH="$HOME/.config/zsh/plugins/to-zsh/to.zsh"

if [ -f "$TO_FUNC_PATH" ]; then

  if ! . "$TO_FUNC_PATH" 2>&1; then
    echo "Error: Failed to source \"$(basename "$TO_FUNC_PATH")\"" >&2
  fi

else

  echo "Error: \"$(basename "$TO_FUNC_PATH")\" not found at:" >&2
  echo "  $TO_FUNC_PATH" >&2
fi

unset TO_FUNC_PATH
# <<< to-zsh init <<<
EOF
)

escapedSnippet="$(printf '%s\n' "$snippet" | sed -e 's/[\\/&]/\\&/g')"
tempFile="$(mktemp)"
blockAction="added"

if grep -q "$startMarker" "$zshrc"; then

  perl -0777 -pe "s|$startMarker.*?$endMarker|$escapedSnippet|s" "$zshrc" > "$tempFile"
  blockAction="updated"

else

  cat "$zshrc" > "$tempFile"

  printf '\n%s\n' "$snippet" >> "$tempFile"
fi

if cmp -s "$tempFile" "$zshrc"; then
  blockAction="unchanged"
  rm "$tempFile"
else
  mv "$tempFile" "$zshrc"
fi

printf 'to-zsh script at %s (%s)\n' "$targetScript" "$copyAction"
printf 'Ensured init block in %s (%s)\n' "$zshrc" "$blockAction"
printf 'to-zsh installation complete.\n'
